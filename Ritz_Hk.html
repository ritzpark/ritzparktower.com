<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Ritz HK Mobile</title>
<style>
  body{margin:0;background:#f5f5f5;font-family:sans-serif;color:#222}
  .wrap{max-width:480px;margin:0 auto;padding:10px}
  .card{background:#fff;border-radius:10px;padding:12px;margin-bottom:10px;box-shadow:0 3px 8px rgba(0,0,0,0.1)}
  .hidden{display:none!important}
  input{width:100%;padding:5px;border-radius:6px;border:1px solid #ccc;font-size:15px}
  .btn{padding:5px;border-radius:6px;border:none;cursor:pointer;font-weight:bold}
  .btn.blue{background:#2E2EFE;color:#fff}
  .btn.gray{background:#ccc;color:#000}
  .btn.red{background:#fff;color:#c00;border:2px solid #f3c2c2}
  .room-grid{display:flex;flex-wrap:wrap;gap:4px}
  .room-btn{flex:1 1 49%;padding:20px;font-weight:bold;text-align:center;border-radius:6px;border:2px solid #ccc;background:#fff}
  .room-btn.updated{background:#d4f4d0;border-color:#8bc48b;color:#095d09}
.room-btn.noservice {
  background: #fff7c2;        /* light yellow */
  border-color: #e0b600;
  color: #7a6200;
}

  .room-btn.mismatch{background:#ffd6d6;border-color:#cc0000;color:#a10000}
  .top-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  h2{margin:10px 0 8px 0;font-size:25px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:4px}
  .col-card{background:#fafafa;border-radius:4px;padding:1px}
  .item-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .item-label{font-size:16px}
  .controls{display:flex;align-items:center;gap:4px}
  .small-btn{width:25px;height:25px;border-radius:4px;font-size:25px;font-weight:bold;border:1px solid #ccc}
  .small-btn.plus{background:#2E2EFE;color:#fff}
  .value{min-width:25px;text-align:center;background:#eee;padding:4px;border-radius:4px}
  .actions{display:flex;gap:4px;margin-top:10px}
  .preview-grid {
  margin-top: 10px;
  max-height: 400px;   /* or whatever fits nicely on mobile */
  overflow-y: auto;
}
  .preview{background:#f3f3f3;padding:6px;border-radius:6px;font-size:13px;margin-bottom:4px}
  .muted{font-size:13px;color:#666}
</style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="screen-login" class="card">
    <h2>Login</h2>
    <p class="muted">Enter floor password</p>
    <input id="passwordInput" type="password" placeholder="Password">
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="btnLogin" class="btn blue" style="flex:1">Login</button>
    </div>
    <div id="loginError" class="muted" style="color:#c00;margin-top:6px;display:none"></div>
  </div>

  <!-- ROOM LIST -->
  <div id="screen-rooms" class="card hidden">
    <div class="top-row">
      <div>
        <div id="selectedFloor" style="font-weight:bold"></div>
        <div id="staffNameTop" class="muted"></div>
        <div id="noticeText" class="muted" style="font-style:italic"></div>
      </div>
      <button id="btnLogout" class="btn gray">Logout</button>
    </div>
    <h2>Rooms</h2>
    <div id="roomsList" class="room-grid"></div>

    <!-- TOTAL SUMMARY -->
    <div id="summaryCard" style="margin-top:15px; padding:10px; background:#fafafa; border-radius:8px; border:1px solid #ddd;">
      <h3 style="margin-top:0;">ðŸ§¾ Total Summary (All Rooms Today)</h3>
      <div id="summaryTable" style="font-size:14px; line-height:1.6;">Loading...</div>
    </div>
  </div>

  <!-- ROOM UPDATE -->
  <div id="screen-room" class="card hidden">
    <div class="top-row">
      <div>
        <div id="ROOMNUMBER" style="font-weight:bold;font-size:18px"></div>
        <div id="STAFFNAME" class="muted"></div>
        <div id="DATE" class="muted"></div>
      </div>
      <button id="btnRoomsBack" class="btn gray">Back</button>
    </div>

    <div class="two-col">
      <div class="col-card">
        <h2>Replace</h2>
        <div id="replaceContainer"></div>
      </div>
      <div class="col-card">
        <h2>Remove</h2>
        <div id="removeContainer"></div>
      </div>
    </div>

    <div style="margin-top:8px;display:flex;gap:6px">
      <input id="hours" type="text" placeholder="Hours">
      <input id="Minutes" type="text" placeholder="Minutes">
    </div>

   <div class="actions">
  <button id="btnSubmit" class="btn blue" style="flex:1">DONE</button>
  <button id="btnRefresh" class="btn gray" style="flex:1">REFRESH</button>
  <button id="btnClear" class="btn red" style="flex:1">CLEAR</button>
  <button id="btnNoService" class="btn" style="flex:1;background:#ffcc00;color:#000;font-weight:bold;">NO SERVICE</button>
</div>


    <h2>Last 3 Days Record</h2>
    <div id="lastPreview" class="preview-grid"></div>
    <div id="submitMsg" class="muted" style="margin-top:6px;display:none"></div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyCOxc6WfkoFZ5j-NXCZc3ZIi10nP34HBDM",
  authDomain:"ritz-hk.firebaseapp.com",
  databaseURL:"https://ritz-hk-default-rtdb.firebaseio.com",
  projectId:"ritz-hk",
  storageBucket:"ritz-hk.appspot.com",
  messagingSenderId:"975572159061",
  appId:"1:975572159061:web:f280915806e9820abd22dc",
  measurementId:"G-Z6J3WDJQ4J"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const REPLACE_KEYS = [
  'Twin Bed Sheet Replace',
  'Twin Duvet Cover Replace',
  'King Bed Sheet Replace',
  'King Duvet Cover Replace',
  'Pillowcase Replace',
  'Bath Towel Replace',
  'Hand Towel Replace',
  'Bath Mat Replace',
  'Pool Towel Replace'     // âœ… added
];
const REMOVE_KEYS = [
  'Twin Bed Sheet Remove',
  'Twin Duvet Cover Remove',
  'King Bed Sheet Remove',
  'King Duvet Cover Remove',
  'Pillowcase Remove',
  'Bath Towel Remove',
  'Hand Towel Remove',
  'Bath Mat Remove',
  'Pool Towel Remove'      // âœ… added
];

function $(id){return document.getElementById(id);}
function today(){const d=new Date();return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}-${d.getFullYear()}`;}
function showScreen(name){['screen-login','screen-rooms','screen-room'].forEach(id=>$(id).classList.toggle('hidden',id!==name));}

// ðŸ” LOGIN (FIXED)
async function findFloor(pw) {
  try {
    const snap = await db.ref('Password/Key').once('value');
    const data = snap.val() || {};
    console.log('Password data:', data);
    const passwordMap = {
  [data.Pass2]: "2ND FLOOR",
  [data.Pass3]: "3RD FLOOR",
  [data.Pass4]: "4TH FLOOR",
  [data.Pass5]: "5TH FLOOR",
  [data.Pass6]: "6TH FLOOR",
  [data.Pass7]: "7TH FLOOR",
  [data.Pass8]: "8TH FLOOR",
  [data.Pass9]: "9TH FLOOR",
  [data.Pass10]: "10TH FLOOR",
  [data.Pass11]: "11TH FLOOR",
  [data.Pass12]: "12TH FLOOR",
  [data.Pass13]: "13TH FLOOR",
  [data.Pass14]: "14TH FLOOR"
};
    return passwordMap[pw] ? { floor: passwordMap[pw] } : null;
  } catch (err) {
    console.error('Firebase password read error:', err);
    return null;
  }
}

$('btnLogin').onclick = async () => {
  const pw = $('passwordInput').value.trim();
  $('loginError').style.display = 'none';
  if (!pw) {
    $('loginError').innerText = 'Enter password';
    $('loginError').style.display = 'block';
    return;
  }
  $('btnLogin').disabled = true;
  $('btnLogin').innerText = 'Checking...';

  const floorMap = await findFloor(pw);
  console.log('Floor found:', floorMap);

  if (!floorMap) {
    $('loginError').innerText = 'Password not valid or network issue';
    $('loginError').style.display = 'block';
    $('btnLogin').disabled = false;
    $('btnLogin').innerText = 'Login';
    return;
  }

  currentFloor = floorMap.floor;
  $('btnLogin').innerText = 'Loading...';
  await loadRooms(currentFloor);
  showScreen('screen-rooms');
  $('btnLogin').disabled = false;
  $('btnLogin').innerText = 'Login';
};

let currentFloor=null,currentRoom=null,currentStaff='';

// ðŸ¢ LOAD ROOMS (fast first, then summary)
async function loadRooms(floor) {
  $('roomsList').innerHTML = 'Loading...';
  $('summaryTable').innerHTML = 'Loading summary...';

  const snap = await db.ref(`RoomsData/${floor}`).once('value');
  const data = snap.val() || {};
  currentStaff = data.NAME || '';
  $('selectedFloor').innerText = floor;
  $('staffNameTop').innerText = `Staff: ${currentStaff}`;
  $('noticeText').innerText = data.NOTICE || '';

  const rooms = [];
 Object.entries(data).forEach(([k, v]) => {
  if (k.startsWith('Room') || k.startsWith('ExtraRoom')) {
    const val = String(v).trim().toLowerCase();
    // skip if marked as no extra or empty
    if (!val || val === 'no extra' || val === 'no' || val === 'noextra') return;
    rooms.push(v);
  }
});
  rooms.sort((a,b)=>parseInt(a)-parseInt(b));

  $('roomsList').innerHTML='';
  for(const r of rooms){
    const btn=document.createElement('button');
    btn.className='room-btn';
    btn.textContent=r;
    btn.dataset.room=r;
    btn.onclick=()=>openRoom(r);
    $('roomsList').append(btn);
  }

  setTimeout(()=>loadSummary(floor,rooms),200);
}

// ðŸ§® LOAD SUMMARY + COLORS
async function loadSummary(floor, rooms) {
  const todayDataSnap = await db.ref('DailyAttended').once('value');
  const todayData = todayDataSnap.val() || {};
  const totalReplace={}, totalRemove={};
  REPLACE_KEYS.forEach(k=>totalReplace[k]=0);
  REMOVE_KEYS.forEach(k=>totalRemove[k]=0);

  for (const r of rooms) {
  const btn = document.querySelector(`.room-btn[data-room="${r}"]`);
  const todayKey = `${r}-${today()}`;
  if (todayData[todayKey]) {
    const roomData = todayData[todayKey];

    // ðŸŸ¡ If room is marked "No Service"
    if (roomData['Note'] && roomData['Note'].toLowerCase().includes('no service')) {
      btn.classList.add('noservice');
      continue; // skip normal Replace/Remove logic
    }

    // âœ… Normal replace/remove comparison logic
    let allMatch = true;
    for (let i = 0; i < REPLACE_KEYS.length; i++) {
      const repKey = REPLACE_KEYS[i], remKey = REMOVE_KEYS[i];
      const repVal = Number(roomData[repKey] || 0), remVal = Number(roomData[remKey] || 0);
      if (repVal !== remVal) allMatch = false;
      totalReplace[repKey] += repVal;
      totalRemove[remKey] += remVal;
    }

    if (allMatch) btn.classList.add('updated');
    else btn.classList.add('mismatch');
  }
}


  let html='';
  for(let i=0;i<REPLACE_KEYS.length;i++){
    const rKey=REPLACE_KEYS[i], mKey=REMOVE_KEYS[i];
    const label=rKey.replace(' Replace','');
    html+=`<div><b>${label}</b>: Replace = ${totalReplace[rKey]||0} | Remove = ${totalRemove[mKey]||0}</div>`;
  }
  $('summaryTable').innerHTML=html||'No data today';
}

// Counter creation
function makeRow(label,key){
  const row=document.createElement('div');row.className='item-row';row.dataset.key=key;
  const l=document.createElement('div');l.className='item-label';l.textContent=label;
  const c=document.createElement('div');c.className='controls';
  const m=document.createElement('button');m.className='small-btn';m.textContent='âˆ’';
  const v=document.createElement('div');v.className='value';v.textContent='0';
  const p=document.createElement('button');p.className='small-btn plus';p.textContent='+';
  m.onclick=()=>{let x=+v.textContent;if(x>0)v.textContent=x-1;};
  p.onclick=()=>{v.textContent=+v.textContent+1;};
  c.append(m,v,p);row.append(l,c);return row;
}
function renderCounters(){
  $('replaceContainer').innerHTML='';$('removeContainer').innerHTML='';
  REPLACE_KEYS.forEach(k=>$('replaceContainer').append(makeRow(k.replace(' Replace',''),k)));
  REMOVE_KEYS.forEach(k=>$('removeContainer').append(makeRow(k.replace(' Remove',''),k)));
}
renderCounters();

// OPEN ROOM
async function openRoom(r){
  currentRoom=r;$('ROOMNUMBER').innerText=r;
  $('STAFFNAME').innerText=`Staff: ${currentStaff}`;
  $('DATE').innerText=today();
  $('hours').value='';$('Minutes').value='';
  document.querySelectorAll('.value').forEach(v=>v.textContent='0');
  showScreen('screen-room');
  await loadTodayValues(r);
  await loadLastPreview(r);
}

async function loadTodayValues(r){
  for(const key of [...REPLACE_KEYS,...REMOVE_KEYS]){
    const snap=await db.ref(`DailyAttended/${r}-${today()}/${key}`).once('value');
    const val=snap.val();const row=document.querySelector(`.item-row[data-key="${key}"]`);
    if(row&&val){row.querySelector('.value').textContent=val;}
  }
}

async function loadLastPreview(r){
  $('lastPreview').innerHTML = '';
  const now = new Date();

  for (let i = 1; i <= 7; i++) {   // âœ… show last 7 days
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const dateStr = `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}-${d.getFullYear()}`;

    const snap = await db.ref(`DailyAttended/${r}-${dateStr}`).once('value');
    const data = snap.val();

    const head = document.createElement('div');
    head.className = 'preview';
    head.style.background = '#e9f0ff';
    head.textContent = `ðŸ“… ${dateStr}`;
    $('lastPreview').append(head);

    if (!data) {
      const no = document.createElement('div');
      no.className = 'preview';
      no.textContent = 'No record';
      $('lastPreview').append(no);
      continue;
    }

    const grid = document.createElement('div');
    grid.style.display = 'grid';
    grid.style.gridTemplateColumns = '1fr 1fr';
    grid.style.gap = '4px';

    const rep = document.createElement('div');
    rep.innerHTML = '<b>Replace</b><br>';
    REPLACE_KEYS.forEach(k => rep.innerHTML += `${k.replace(' Replace','')}: ${data[k] || '-'}<br>`);

    const rem = document.createElement('div');
    rem.innerHTML = '<b>Remove</b><br>';
    REMOVE_KEYS.forEach(k => rem.innerHTML += `${k.replace(' Remove','')}: ${data[k] || '-'}<br>`);

    grid.append(rep, rem);
    $('lastPreview').append(grid);
  }
}

// Buttons
$('btnRoomsBack').onclick = ()=>showScreen('screen-rooms');
$('btnLogout').onclick = ()=>showScreen('screen-login');
$('btnClear').onclick = ()=>document.querySelectorAll('.value').forEach(v=>v.textContent='0');

$('btnNoService').onclick = async ()=>{
  // Clear all counters
  document.querySelectorAll('.value').forEach(v=>v.textContent='0');
  if (!currentRoom) return;
  const data = {
    'Staff Name': currentStaff,
    'Time In': new Date().toLocaleTimeString(),
    'Time Out': new Date().toLocaleTimeString(),
    'Note': 'No Service'
  };
  await db.ref(`DailyAttended/${currentRoom}-${today()}`).set(data);
  $('submitMsg').innerText = 'Marked as NO SERVICE!';
  $('submitMsg').style.display = 'block';
  setTimeout(()=>{showScreen('screen-rooms'); loadRooms(currentFloor);},1000);
};

$('btnRefresh').onclick = async ()=>{
  if (currentRoom) {
    await loadTodayValues(currentRoom);
    await loadLastPreview(currentRoom);
  }
};


// SUBMIT
$('btnSubmit').onclick=async()=>{
  if(!currentRoom)return;
  const h=$('hours').value.trim(),m=$('Minutes').value.trim();
  if(!h||!m){alert('Enter hours & minutes');return;}
  const data={'Staff Name':currentStaff,'Time Out':new Date().toLocaleTimeString()};
  const now=new Date(),period=now.getHours()<12?'AM':'PM';
  data['Time In']=`${h.padStart(2,'0')}:${m.padStart(2,'0')} ${period}`;
  document.querySelectorAll('.item-row').forEach(r=>data[r.dataset.key]=r.querySelector('.value').textContent);
  await db.ref(`DailyAttended/${currentRoom}-${today()}`).update(data);
  $('submitMsg').innerText='Submitted!';$('submitMsg').style.display='block';
  await loadRooms(currentFloor);showScreen('screen-rooms');
};
</script>
</body>
</html>
