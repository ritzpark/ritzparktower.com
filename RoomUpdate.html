<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Housekeeping Admin Panel</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg:#f2f4f8; --card:#ffffff; --muted:#6b7280;
    --accent:#1f6feb; --ok:#1e7e34; --warn:#d6333f;
    --glass: rgba(255,255,255,0.8);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#f6f8fb 0%,var(--bg) 100%);color:#0f1724}
  .container{max-width:1200px;margin:28px auto;padding:22px}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6b90ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
  h1{margin:0;font-size:20px}
  .controls{display:flex;align-items:center;gap:8px}
  input[type="date"]{padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;background:#fff}
  button.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  button.primary{background:var(--accent);color:#fff}
  button.ghost{background:transparent;border:1px solid #e6e9ef;color:var(--muted)}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(19,24,47,0.06)}
  .login-wrap{display:flex;align-items:center;justify-content:center;min-height:72vh}
  .login-card{width:520px;padding:28px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#fbfdff);box-shadow:0 10px 30px rgba(2,6,23,0.08)}
  .login-card h2{margin:0 0 8px 0;font-size:22px}
  .muted{color:var(--muted);font-size:14px}
  .field{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  input[type="password"]{padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:15px}
  .error{color:var(--warn);margin-top:8px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:14px}
  .floor-card{padding:18px;border-radius:12px;transition:transform .12s,box-shadow .12s;cursor:pointer;display:flex;flex-direction:column;gap:10px}
  .floor-card:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(12,22,60,0.08)}
  .floor-title{display:flex;align-items:center;justify-content:space-between}
  .floor-name{font-weight:700;font-size:16px}
  .stats{display:flex;gap:10px;align-items:center}
  .stat{padding:8px 12px;border-radius:8px;background:rgba(15,23,36,0.03);font-weight:600}
  .stat.small{font-weight:500;font-size:13px}
  .ok{color:var(--ok);font-weight:700}
  .bad{color:var(--warn);font-weight:700}
  .floor-meta{color:var(--muted);font-size:13px}
  .back-btn{margin-bottom:12px}
  .table-wrap{overflow:auto;background:transparent;margin-top:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #eef2f6}
  th{font-size:13px;color:var(--muted);font-weight:700}
  td .small{font-size:13px;color:var(--muted)}
  tr.okrow{background:linear-gradient(90deg,rgba(34,197,94,0.06),transparent)}
  tr.badrow{background:linear-gradient(90deg,rgba(214,51,63,0.05),transparent)}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700;font-size:13px}
  .pill.ok{background:rgba(34,197,94,0.12);color:var(--ok)}
  .pill.bad{background:rgba(214,51,63,0.08);color:var(--warn)}
  @media(max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:820px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.grid{grid-template-columns:1fr}.container{padding:12px}}
</style>
</head>
<body>
<div class="container">

  <div id="headerTop" class="header card">
    <div class="brand">
      <div class="logo">HK</div>
      <div>
        <h1>Housekeeping — Admin Panel</h1>
        <div class="muted">Supervisor dashboard — monitor floors, rooms & reports</div>
      </div>
    </div>
    <div class="controls">
      <label class="muted">Date</label>
      <input id="datePicker" type="date">
      <button id="btnLogout" class="btn ghost" style="display:none">Logout</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="screen-login" class="login-wrap">
    <div class="login-card card">
      <h2>Admin Login</h2>
      <div class="muted">Enter password stored in <code>Password/AdminKey</code></div>
      <div class="field">
        <input id="adminPass" type="password" placeholder="Admin password">
        <div style="display:flex;gap:8px;">
          <button id="btnAdminLogin" class="btn primary">Login</button>
          <button id="btnDemo" class="btn ghost">Demo</button>
        </div>
        <div id="loginErr" class="error" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="screen-dashboard" class="card" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h2 style="margin:0">Overview</h2>
        <div class="muted">Floors 2 — 14. Click any floor for details.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="btnRefreshDashboard" class="btn ghost">Refresh</button>
        <button id="btnExportAll" class="btn ghost">Export All CSV</button>
      </div>
    </div>

    <!-- Add Extra Room -->
    <div id="extraRoomPanel" style="margin-top:20px;padding:14px;border-radius:8px;background:#f9fafb;border:1px solid #e5e7eb;">
      <h3 style="margin-top:0;">➕ Add Extra Room</h3>
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
        <select id="floorSelect" style="padding:8px;border-radius:8px;border:1px solid #ccc;">
          <option value="">Select Floor</option>
          <option>2ND FLOOR</option><option>3RD FLOOR</option><option>4TH FLOOR</option>
          <option>5TH FLOOR</option><option>6TH FLOOR</option><option>7TH FLOOR</option>
          <option>8TH FLOOR</option><option>9TH FLOOR</option><option>10TH FLOOR</option>
          <option>11TH FLOOR</option><option>12TH FLOOR</option><option>13TH FLOOR</option><option>14TH FLOOR</option>
        </select>
        <input id="extraRoomNumber" type="text" placeholder="Enter room number" style="padding:8px;border-radius:8px;border:1px solid #ccc;width:150px;">
        <button id="btnAddExtraRoom" class="btn primary">Add Room</button>
        <div id="extraRoomMsg" class="muted" style="margin-left:8px;"></div>
      </div>
    </div>

    <div id="floorsGrid" class="grid" style="margin-top:14px"></div>
  </div>

  <!-- FLOOR DETAILS -->
  <div id="screen-floor" class="card" style="display:none">
    <button id="btnBackToDash" class="btn ghost back-btn">← Back</button>
    <h2 id="floorTitle">Floor</h2>
    <div id="floorSummary" class="muted" style="font-weight:600"></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Room</th><th>Staff</th><th>Time In</th><th>Time Out</th><th>Replace</th><th>Remove</th><th>Status</th></tr>
        </thead>
        <tbody id="roomTableBody"></tbody>
      </table>
    </div>
    <button id="btnExportCSV" class="btn primary" style="margin-top:10px;">Export CSV</button>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCOxc6WfkoFZ5j-NXCZc3ZIi10nP34HBDM",
  authDomain: "ritz-hk.firebaseapp.com",
  databaseURL: "https://ritz-hk-default-rtdb.firebaseio.com",
  projectId: "ritz-hk",
  storageBucket: "ritz-hk.appspot.com",
  messagingSenderId: "975572159061",
  appId: "1:975572159061:web:f280915806e9820abd22dc",
  measurementId: "G-Z6J3WDJQ4J"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
function $(id){return document.getElementById(id);}
function todayISO(){const d=new Date();return d.toISOString().split('T')[0];}
function keyFromISO(iso){const d=new Date(iso);return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}-${d.getFullYear()}`;}
const FLOORS=["2ND FLOOR","3RD FLOOR","4TH FLOOR","5TH FLOOR","6TH FLOOR","7TH FLOOR","8TH FLOOR","9TH FLOOR","10TH FLOOR","11TH FLOOR","12TH FLOOR","13TH FLOOR","14TH FLOOR"];
const REPLACE_KEYS=['Twin Bed Sheet Replace','Twin Duvet Cover Replace','King Bed Sheet Replace','King Duvet Cover Replace','Pillowcase Replace','Bath Towel Replace','Hand Towel Replace','Bath Mat Replace'];
const REMOVE_KEYS=['Twin Bed Sheet Remove','Twin Duvet Cover Remove','King Bed Sheet Remove','King Duvet Cover Remove','Pillowcase Remove','Bath Towel Remove','Hand Towel Remove','Bath Mat Remove'];

let ADMIN_OK=false,currentFloor=null,currentDateKey=keyFromISO(todayISO());
$('datePicker').value=todayISO();
$('datePicker').addEventListener('change',()=>{currentDateKey=keyFromISO($('datePicker').value);if($('screen-dashboard').style.display!=='none')loadDashboardFast();});
async function getAdminKey(){try{const s=await db.ref('Password/AdminKey').once('value');return s.val();}catch(e){return null;}}
$('btnAdminLogin').onclick=async()=>{const pw=$('adminPass').value.trim();if(!pw)return;const key=await getAdminKey();if(String(key).trim()===pw){ADMIN_OK=true;showDashboard();}else alert('Invalid password');};
$('btnDemo').onclick=()=>{ADMIN_OK=true;showDashboard();};
$('btnLogout').onclick=()=>{ADMIN_OK=false;$('screen-login').style.display='flex';$('screen-dashboard').style.display='none';$('btnLogout').style.display='none';};
function showDashboard(){$('screen-login').style.display='none';$('screen-dashboard').style.display='block';$('btnLogout').style.display='inline-block';loadDashboardFast();}
async function loadDashboardFast(){const grid=$('floorsGrid');grid.innerHTML='';FLOORS.forEach(f=>{const c=document.createElement('div');c.className='card floor-card';c.innerHTML=`<div class="floor-title"><div class="floor-name">${f}</div><div class="floor-meta muted">--</div></div><div style="display:flex;justify-content:space-between"><div><div class="muted">Total</div><div class="stat small">--</div></div><div><div class="muted">Completed</div><div class="stat small ok">--</div></div><div><div class="muted">Mismatch</div><div class="stat small bad">--</div></div></div>`;c.onclick=()=>openFloorDetails(f);grid.appendChild(c);});setTimeout(()=>loadDashboardSummary(currentDateKey),200);}
async function loadDashboardSummary(dateKey){try{const roomSnaps=await Promise.all(FLOORS.map(f=>db.ref(`RoomsData/${f}`).once('value')));const dailySnap=await db.ref('DailyAttended').once('value');const daily=dailySnap.val()||{};FLOORS.forEach((f,i)=>{const card=[...$('floorsGrid').children].find(x=>x.querySelector('.floor-name').textContent===f);const d=roomSnaps[i].val()||{};const rooms=Object.entries(d).filter(([k])=>k.startsWith('Room')||k.startsWith('ExtraRoom')).map(([,v])=>v).filter(Boolean);let total=rooms.length,done=0,bad=0;rooms.forEach(r=>{const rec=daily[`${r}-${dateKey}`];if(rec){let all=REPLACE_KEYS.every((k,j)=>Number(rec[k]||0)===Number(rec[REMOVE_KEYS[j]]||0));if(all)done++;else bad++;}});card.querySelector('.stat.small').textContent=total;card.querySelector('.stat.small.ok').textContent=done;card.querySelector('.stat.small.bad').textContent=bad;card.style.borderLeft=bad?'4px solid var(--warn)':done?'4px solid var(--ok)':'4px solid transparent';});}catch(e){console.error(e);}}
$('btnRefreshDashboard').onclick=()=>loadDashboardFast();
async function openFloorDetails(floor){currentFloor=floor;$('screen-dashboard').style.display='none';$('screen-floor').style.display='block';$('floorTitle').textContent=floor;const snap=await db.ref(`RoomsData/${floor}`).once('value');const data=snap.val()||{};const rooms=Object.entries(data).filter(([k])=>k.startsWith('Room')||k.startsWith('ExtraRoom')).map(([,v])=>v).filter(Boolean);$('roomTableBody').innerHTML='';let ok=0,bad=0;for(const r of rooms){const val=(await db.ref(`DailyAttended/${r}-${currentDateKey}`).once('value')).val()||{};let all=REPLACE_KEYS.every((k,i)=>Number(val[k]||0)===Number(val[REMOVE_KEYS[i]]||0));if(Object.keys(val).length){if(all)ok++;else bad++;}const rep=REPLACE_KEYS.map(k=>`${k.split(' ')[0]}:${val[k]||0}`).join('<br>');const rem=REMOVE_KEYS.map(k=>`${k.split(' ')[0]}:${val[k]||0}`).join('<br>');$('roomTableBody').innerHTML+=`<tr class="${all?'okrow':Object.keys(val).length&&!all?'badrow':''}"><td>${r}</td><td>${val['Staff Name']||'-'}</td><td>${val['Time In']||'-'}</td><td>${val['Time Out']||'-'}</td><td>${rep}</td><td>${rem}</td><td>${Object.keys(val).length?(all?'<span class="pill ok">OK</span>':'<span class="pill bad">Mismatch</span>'):'<span class="pill">No Data</span>'}</td></tr>`;}
$('floorSummary').textContent=`Total ${rooms.length}, OK ${ok}, Mismatch ${bad}`;}
$('btnBackToDash').onclick=()=>{$('screen-floor').style.display='none';$('screen-dashboard').style.display='block';};
$('btnExportCSV').onclick=async()=>{if(!currentFloor)return;const rows=[['Room','Staff','Time In','Time Out',...REPLACE_KEYS,...REMOVE_KEYS,'Status']];const snap=await db.ref(`RoomsData/${currentFloor}`).once('value');const data=snap.val()||{};const rooms=Object.entries(data).filter(([k])=>k.startsWith('Room')||k.startsWith('ExtraRoom')).map(([,v])=>v).filter(Boolean);for(const r of rooms){const val=(await db.ref(`DailyAttended/${r}-${currentDateKey}`).once('value')).val()||{};const ok=Object.keys(val).length&&REPLACE_KEYS.every((k,i)=>Number(val[k]||0)===Number(val[REMOVE_KEYS[i]]||0));rows.push([r,val['Staff Name']||'',val['Time In']||'',val['Time Out']||'',...REPLACE_KEYS.map(k=>val[k]||0),...REMOVE_KEYS.map(k=>val[k]||0),ok?'OK':'Mismatch']);}const csv=rows.map(r=>r.join(',')).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=`${currentFloor.replace(/\s+/g,'_')}_${currentDateKey}.csv`;a.click();};
$('btnExportAll').onclick=async()=>{const rows=[['Floor','Room','Staff','Time In','Time Out',...REPLACE_KEYS,...REMOVE_KEYS,'Status']];for(const f of FLOORS){const snap=await db.ref(`RoomsData/${f}`).once('value');const data=snap.val()||{};const rooms=Object.entries(data).filter(([k])=>k.startsWith('Room')||k.startsWith('ExtraRoom')).map(([,v])=>v).filter(Boolean);for(const r of rooms){const val=(await db.ref(`DailyAttended/${r}-${currentDateKey}`).once('value')).val()||{};const ok=Object.keys(val).length&&REPLACE_KEYS.every((k,i)=>Number(val[k]||0)===Number(val[REMOVE_KEYS[i]]||0));rows.push([f,r,val['Staff Name']||'',val['Time In']||'',val['Time Out']||'',...REPLACE_KEYS.map(k=>val[k]||0),...REMOVE_KEYS.map(k=>val[k]||0),ok?'OK':'Mismatch']);}}const csv=rows.map(r=>r.join(',')).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=`AllFloors_${currentDateKey}.csv`;a.click();};

/* ADD EXTRA ROOM FEATURE */
$('btnAddExtraRoom').addEventListener('click', async ()=>{
  const floor=$('floorSelect').value.trim();
  const room=$('extraRoomNumber').value.trim();
  const msg=$('extraRoomMsg');
  msg.textContent='';
  if(!floor||!room){msg.textContent='⚠️ Select floor and enter room';return;}
  try{
    const ref=db.ref(`RoomsData/${floor}`);
    const snap=await ref.once('value');
    const data=snap.val()||{};
    let slot=null;
    for(let i=1;i<=5;i++){
      const key=`ExtraRoom${i}`;
      const val=(data[key]||'').toString().trim().toLowerCase();
      if(!val||val==='no extra'||val==='no'||val==='noextra'){slot=key;break;}
    }
    if(!slot){msg.textContent='❌ All 5 extra slots used.';return;}
    await ref.update({[slot]:room});
    msg.textContent=`✅ Added ${room} to ${floor} (${slot})`;
    $('extraRoomNumber').value='';
    loadDashboardFast();
  }catch(e){console.error(e);msg.textContent='❌ Failed to add room.';}
});

/* Init */
$('screen-login').style.display='flex';
</script>
</body>
</html>
