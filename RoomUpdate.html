<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Housekeeping Admin Panel</title>
<style>
  body{margin:0;font-family:Inter,system-ui,Arial;background:#f4f6fb;color:#0f1724}
  .wrap{max-width:1100px;margin:24px auto;padding:18px}
  .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:12px}
  h1{margin:0 0 6px 0;font-size:20px}
  .muted{color:#6b7280;font-size:13px}
  input,select,textarea,button{font-family:inherit}
  input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6e9ef}
  button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  button.primary{background:#2563eb;color:#fff}
  button.ghost{background:#fff;border:1px solid #e6e9ef;color:#374151}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
  .floor-card{padding:12px;border-radius:10px;border:1px solid #eef2f6;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px 10px;border-bottom:1px solid #eef2f6;text-align:left}
  th{color:#6b7280;font-size:13px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}
  .pill.ok{background:#dcfce7;color:#166534}
  .pill.bad{background:#fee2e2;color:#991b1b}
  pre{white-space:pre-wrap;margin:0;font-family:inherit}
  .smallmuted{font-size:12px;color:#6b7280}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Housekeeping ‚Äî Admin Panel</h1>
        <div class="muted">Manage floors, passwords, notices & exports</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="datePicker" type="date">
        <button id="btnLogout" class="ghost" style="display:none">Logout</button>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h3>Admin Login</h3>
    <div class="muted">Enter Admin password (Password/AdminKey)</div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <input id="adminPass" type="password" placeholder="Admin password">
      <button id="btnAdminLogin" class="primary">Login</button>
      <button id="btnDemo" class="ghost">Demo</button>
    </div>
    <div id="loginErr" class="smallmuted" style="color:#b91c1c;margin-top:8px;display:none"></div>
  </div>

  <!-- DASHBOARD -->
  <div id="mainPanel" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">Dashboard</h3>
          <div class="muted">Click floor for details. Date controls which DailyAttended date is shown.</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="btnRefreshDashboard" class="ghost">Refresh</button>
          <button id="btnExportAll" class="ghost">Export All CSV</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:0 0 6px 0">‚ûï Add Extra Room</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <select id="floorSelect"><option value="">Select Floor</option></select>
          <input id="extraRoomNumber" placeholder="Room number (e.g. 2005)">
          <button id="btnAddExtraRoom" class="primary">Add Room</button>
          <div id="extraRoomMsg" class="smallmuted"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 8px 0">üîë Floor Passwords (Pass2..Pass14)</h4>
      <div id="pwList" class="smallmuted">Loading...</div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 8px 0">üì¢ Floor Notice Editor</h4>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <select id="noticeFloorSel"><option value="">Select Floor</option></select>
        <button id="btnLoadFloorNotice" class="ghost">Load</button>
        <button id="btnSaveFloorNotice" class="primary">Save</button>
      </div>
      <textarea id="noticeText" rows="3" style="width:100%;margin-top:8px" placeholder="Notice stored at RoomsData/{FLOOR}/NOTICE"></textarea>
      <div id="noticeMsg" class="smallmuted" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 8px 0">Floors</h4>
      <div id="floorsGrid" class="grid"></div>
    </div>

    <div id="floorDetails" class="card" style="display:none">
      <button id="btnBackToDash" class="ghost">‚Üê Back</button>
      <h3 id="floorTitle"></h3>
      <div id="floorSummary" class="smallmuted"></div>
      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr><th>Room</th><th>Staff</th><th>Time In</th><th>Time Out</th><th>Replace</th><th>Remove</th><th>Status</th></tr>
          </thead>
          <tbody id="roomTableBody"></tbody>
        </table>
      </div>
      <div style="margin-top:10px">
        <button id="btnExportCSV" class="primary">Export Floor CSV</button>
      </div>
    </div>
  </div>

</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* CONFIG - use your project config (kept same as provided) */
const firebaseConfig = {
  apiKey: "AIzaSyCOxc6WfkoFZ5j-NXCZc3ZIi10nP34HBDM",
  authDomain: "ritz-hk.firebaseapp.com",
  databaseURL: "https://ritz-hk-default-rtdb.firebaseio.com",
  projectId: "ritz-hk",
  storageBucket: "ritz-hk.appspot.com",
  messagingSenderId: "975572159061",
  appId: "1:975572159061:web:f280915806e9820abd22dc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Helpers */
function $(id){return document.getElementById(id);}
function isoToKey(iso){const d=new Date(iso);return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}-${d.getFullYear()}`;}
function todayISO(){return new Date().toISOString().split('T')[0];}
function currentDateKey(){ const v=$('datePicker').value||todayISO(); return isoToKey(v); }

/* Constants matching your JSON */
const FLOORS = ["2ND FLOOR","3RD FLOOR","4TH FLOOR","5TH FLOOR","6TH FLOOR","7TH FLOOR","8TH FLOOR","9TH FLOOR","10TH FLOOR","11TH FLOOR","12TH FLOOR","13TH FLOOR","14TH FLOOR"];
const REPLACE_KEYS = ['Twin Bed Sheet Replace','Twin Duvet Cover Replace','King Bed Sheet Replace','King Duvet Cover Replace','Pillowcase Replace','Bath Towel Replace','Hand Towel Replace','Bath Mat Replace','Pool Towel Replace'];
const REMOVE_KEYS =  ['Twin Bed Sheet Remove','Twin Duvet Cover Remove','King Bed Sheet Remove','King Duvet Cover Remove','Pillowcase Remove','Bath Towel Remove','Hand Towel Remove','Bath Mat Remove','Pool Towel Remove'];
const ITEMS = ['Twin Bed Sheet','Twin Duvet Cover','King Bed Sheet','King Duvet Cover','Pillowcase','Bath Towel','Hand Towel','Bath Mat','Pool Towel'];

/* Init UI */
$('datePicker').value = todayISO();
FLOORS.forEach(f=>{
  $('floorSelect').innerHTML += `<option>${f}</option>`;
  $('noticeFloorSel').innerHTML += `<option>${f}</option>`;
});

/* LOGIN */
$('btnAdminLogin').addEventListener('click', async ()=>{
  const pw = $('adminPass').value.trim();
  if(!pw){ $('loginErr').textContent='Enter password'; $('loginErr').style.display='block'; return; }
  const snap = await db.ref('Password/AdminKey').once('value');
  const adminKey = snap.val();
  if(String(adminKey).trim() === pw){ $('loginCard').style.display='none'; $('mainPanel').style.display='block'; $('btnLogout').style.display='inline-block'; loadDashboard(); loadPasswordsPanel(); }
  else { $('loginErr').textContent='Invalid admin password'; $('loginErr').style.display='block'; }
});
$('btnDemo').addEventListener('click', ()=>{ $('loginCard').style.display='none'; $('mainPanel').style.display='block'; loadDashboard(); loadPasswordsPanel(); });

$('btnLogout').addEventListener('click', ()=>{ $('mainPanel').style.display='none'; $('loginCard').style.display='block'; $('btnLogout').style.display='none'; });

/* LOAD DASHBOARD (floors grid and counts) */
async function loadDashboard(){
  $('floorsGrid').innerHTML = 'Loading...';
  const allDailySnap = await db.ref('DailyAttended').once('value');
  const daily = allDailySnap.val() || {};
  $('floorsGrid').innerHTML = '';
  for(const floor of FLOORS){
    const roomsSnap = await db.ref(`RoomsData/${floor}`).once('value');
    const roomsObj = roomsSnap.val() || {};
    // collect only actual room values (skip NAME, NOTICE, EXTRA; skip 'NO EXTRA' placeholders)
    const rooms = Object.entries(roomsObj)
      .filter(([k,v]) => (k.toLowerCase().startsWith('room') || k.toLowerCase().startsWith('extraroom')) )
      .map(([,v]) => String(v).trim())
      .filter(v => v && !/no extra/i.test(v) && !/^extra$/i.test(v));
    let ok=0, bad=0;
    for(const r of rooms){
      const rec = daily[`${r}-${currentDateKey()}`];
      if(rec){
        const allMatch = REPLACE_KEYS.every((k,i)=>Number(rec[k]||0) === Number(rec[REMOVE_KEYS[i]]||0));
        if(allMatch) ok++; else bad++;
      }
    }
    const card = document.createElement('div');
    card.className = 'floor-card';
    card.innerHTML = `<strong>${floor}</strong><div class="smallmuted">${rooms.length} rooms</div><div style="margin-top:8px"><span class="pill ok">${ok} OK</span> <span style="margin-left:8px" class="pill bad">${bad} Mismatch</span></div>`;
    card.onclick = ()=> openFloorDetails(floor);
    $('floorsGrid').appendChild(card);
  }
}

/* OPEN FLOOR DETAILS */
async function openFloorDetails(floor){
  $('floorDetails').style.display='block';
  $('floorTitle').textContent = floor;
  $('roomTableBody').innerHTML = 'Loading...';
  const roomsSnap = await db.ref(`RoomsData/${floor}`).once('value');
  const roomsObj = roomsSnap.val() || {};
  const rooms = Object.entries(roomsObj)
    .filter(([k,v]) => (k.toLowerCase().startsWith('room') || k.toLowerCase().startsWith('extraroom')) )
    .map(([,v]) => String(v).trim())
    .filter(v => v && !/no extra/i.test(v) && !/^extra$/i.test(v));
  const dailySnap = await db.ref('DailyAttended').once('value');
  const daily = dailySnap.val() || {};
  $('roomTableBody').innerHTML = '';
  let ok=0,bad=0;
  for(const r of rooms){
    const rec = daily[`${r}-${currentDateKey()}`] || {};
    const hasData = Object.keys(rec).length>0;
    const allMatch = hasData ? REPLACE_KEYS.every((k,i)=>Number(rec[k]||0) === Number(rec[REMOVE_KEYS[i]]||0)) : false;
    if(hasData){ if(allMatch) ok++; else bad++; }
    const rep = ITEMS.map(it => `${it}: ${ (rec[`${it} Replace`]!==undefined && rec[`${it} Replace`]!=='' ) ? rec[`${it} Replace`] : '-' }`).join('<br>');
    const rem = ITEMS.map(it => `${it}: ${ (rec[`${it} Remove`]!==undefined && rec[`${it} Remove`]!=='' ) ? rec[`${it} Remove`] : '-' }`).join('<br>');
    const statusHTML = hasData ? (allMatch ? '<span class="pill ok">OK</span>' : '<span class="pill bad">Mismatch</span>') : '<span class="smallmuted">No Data</span>';
    $('roomTableBody').insertAdjacentHTML('beforeend', `<tr><td>${r}</td><td>${rec['Staff Name']||'-'}</td><td>${rec['Time In']||'-'}</td><td>${rec['Time Out']||'-'}</td><td><pre>${rep}</pre></td><td><pre>${rem}</pre></td><td>${statusHTML}</td></tr>`);
  }
  $('floorSummary').textContent = `Total ${rooms.length}, OK ${ok}, Mismatch ${bad}`;
}

/* Back button */
$('btnBackToDash').addEventListener('click', ()=>{ $('floorDetails').style.display='none'; });

/* Export CSV for floor */
$('btnExportCSV').addEventListener('click', async ()=>{
  const floor = $('floorTitle').textContent;
  if(!floor) return alert('Open a floor first');
  const snap = await db.ref(`RoomsData/${floor}`).once('value');
  const roomsObj = snap.val()||{};
  const rooms = Object.entries(roomsObj)
    .filter(([k,v]) => (k.toLowerCase().startsWith('room') || k.toLowerCase().startsWith('extraroom')) )
    .map(([,v]) => String(v).trim())
    .filter(v => v && !/no extra/i.test(v) && !/^extra$/i.test(v));
  const rows = [['Room','Staff','Time In','Time Out',...REPLACE_KEYS,...REMOVE_KEYS,'Status']];
  for(const r of rooms){
    const rec = (await db.ref(`DailyAttended/${r}-${currentDateKey()}`).once('value')).val() || {};
    const ok = Object.keys(rec).length && REPLACE_KEYS.every((k,i)=>Number(rec[k]||0) === Number(rec[REMOVE_KEYS[i]]||0));
    rows.push([r, rec['Staff Name']||'', rec['Time In']||'', rec['Time Out']||'', ...REPLACE_KEYS.map(k=>rec[k]||0), ...REMOVE_KEYS.map(k=>rec[k]||0), ok?'OK':'Mismatch']);
  }
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = `${floor.replace(/\s+/g,'_')}_${currentDateKey()}.csv`; a.click();
});

/* Export All CSV (fixed async loop) */
$('btnExportAll').addEventListener('click', async ()=>{
  const rows = [['Floor','Room','Staff','Time In','Time Out',...REPLACE_KEYS,...REMOVE_KEYS,'Status']];
  for(const floor of FLOORS){
    const snap = await db.ref(`RoomsData/${floor}`).once('value');
    const roomsObj = snap.val()||{};
    const rooms = Object.entries(roomsObj)
      .filter(([k,v]) => (k.toLowerCase().startsWith('room') || k.toLowerCase().startsWith('extraroom')) )
      .map(([,v]) => String(v).trim())
      .filter(v => v && !/no extra/i.test(v) && !/^extra$/i.test(v));
    for(const r of rooms){
      const rec = (await db.ref(`DailyAttended/${r}-${currentDateKey()}`).once('value')).val() || {};
      const ok = Object.keys(rec).length && REPLACE_KEYS.every((k,i)=>Number(rec[k]||0) === Number(rec[REMOVE_KEYS[i]]||0));
      rows.push([floor, r, rec['Staff Name']||'', rec['Time In']||'', rec['Time Out']||'', ...REPLACE_KEYS.map(k=>rec[k]||0), ...REMOVE_KEYS.map(k=>rec[k]||0), ok?'OK':'Mismatch']);
    }
  }
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = `AllFloors_${currentDateKey()}.csv`; a.click();
});

/* Add Extra Room */
$('btnAddExtraRoom').addEventListener('click', async ()=>{
  const floor = $('floorSelect').value;
  const room = String($('extraRoomNumber').value).trim();
  $('extraRoomMsg').textContent = '';
  if(!floor || !room){ $('extraRoomMsg').textContent = 'Select floor and enter room'; return; }
  const ref = db.ref(`RoomsData/${floor}`);
  const snap = await ref.once('value');
  const data = snap.val() || {};
  // find free ExtraRoom slot (ExtraRoom1..ExtraRoom5)
  let slot = null;
  for(let i=1;i<=6;i++){
    const key = `ExtraRoom${i}`;
    if(!data[key] || /no extra/i.test(String(data[key])) ){ slot = key; break; }
  }
  if(!slot){ $('extraRoomMsg').textContent = 'All extra slots used'; return; }
  await ref.update({ [slot]: room });
  $('extraRoomMsg').textContent = `Added ${room} to ${floor} (${slot})`;
  $('extraRoomNumber').value = '';
  loadDashboard();
  loadPasswordsPanel(); // refresh notices and fields
});

/* PASSWORDS PANEL - load Pass2..Pass14 and allow copy/save */
async function loadPasswordsPanel(){
  const pwRoot = await db.ref('Password/Key').once('value');
  const pwObj = pwRoot.val() || {};
  // render mapping
  const container = $('pwList'); container.innerHTML = '';
  // map floors 2..14 to Pass2..Pass14
  for(let i=2;i<=14;i++){
    const passKey = `Pass${i}`;
    const floorLabel = FLOORS[i-2] || `${i}TH FLOOR`;
    const current = pwObj[passKey] || '';
    const row = document.createElement('div');
    row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.marginBottom='6px';
    row.innerHTML = `<div style="min-width:120px"><strong>${floorLabel}</strong><div class="smallmuted">${passKey}</div></div>
      <input id="inp_${passKey}" value="${current}" style="flex:1;padding:6px;border-radius:6px;border:1px solid #e6e9ef">
      <button onclick="copyPass('${passKey}')" class="ghost">Copy</button>
      <button onclick="savePass('${passKey}')" class="primary">Save</button>`;
    container.appendChild(row);
  }
}
window.copyPass = async (passKey) => {
  const v = document.getElementById(`inp_${passKey}`).value || '';
  await navigator.clipboard.writeText(String(v));
  alert('Copied');
};
window.savePass = async (passKey) => {
  const v = document.getElementById(`inp_${passKey}`).value || '';
  await db.ref(`Password/Key/${passKey}`).set(String(v));
  alert('Saved');
};

/* Floor Notice editor (stored at RoomsData/{FLOOR}/NOTICE) */
$('btnLoadFloorNotice').addEventListener('click', async ()=>{
  const f = $('noticeFloorSel').value;
  if(!f) return alert('Select floor');
  const snap = await db.ref(`RoomsData/${f}/NOTICE`).once('value');
  $('noticeText').value = snap.val() || '';
  $('noticeMsg').textContent = 'Loaded';
});
$('btnSaveFloorNotice').addEventListener('click', async ()=>{
  const f = $('noticeFloorSel').value;
  if(!f) return alert('Select floor');
  const txt = $('noticeText').value || '';
  await db.ref(`RoomsData/${f}/NOTICE`).set(String(txt));
  $('noticeMsg').textContent = 'Saved';
  loadDashboard(); // refresh
});

/* initial load */
$('datePicker').addEventListener('change', ()=> loadDashboard());
$('btnRefreshDashboard').addEventListener('click', ()=> loadDashboard());
loadPasswordsPanel();
</script>
</body>
</html>
